<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TimeTask - Kelola Waktumu</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        /* --- VARIABLES --- */
        :root {
            --primary: #519bc0;
            --secondary: #28712a;
            --accent: #b3d3d9;
            --light-bg: #eef5f7;
            --white: #ffffff;
            --text-dark: #333333;
            --text-light: #666666;
            --danger: #e74c3c;
            --warning: #f1c40f;
            --shadow: 0 4px 15px rgba(0,0,0,0.1);
            --radius: 12px;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Poppins', sans-serif; }
        body { background-color: var(--light-bg); color: var(--text-dark); min-height: 100vh; overflow-x: hidden; }

        /* --- UTILITIES --- */
        .hidden { display: none !important; }
        .btn { padding: 10px 20px; border: none; border-radius: 8px; cursor: pointer; font-weight: 500; transition: 0.3s; font-size: 14px; }
        .btn-primary { background-color: var(--primary); color: white; }
        .btn-secondary { background-color: var(--secondary); color: white; }
        .btn-outline { border: 1px solid var(--primary); color: var(--primary); background: transparent; }
        .btn:hover { opacity: 0.9; transform: translateY(-1px); }
        .btn:disabled { opacity: 0.6; cursor: not-allowed; }
        .btn-icon { padding: 8px; background: none; border: none; cursor: pointer; color: #999; transition: 0.2s; }
        .btn-icon:hover { color: var(--primary); background: #f0f0f0; border-radius: 50%; }
        .btn-icon.delete:hover { color: var(--danger); }

        /* --- LAYOUT --- */
        #auth-container { display: flex; height: 100vh; width: 100%; background: linear-gradient(135deg, var(--accent) 0%, var(--primary) 100%); align-items: center; justify-content: center; padding: 20px; }
        
        .auth-card { display: flex; background: white; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); overflow: hidden; width: 900px; max-width: 100%; min-height: 550px; }
        .auth-left { flex: 1; background: linear-gradient(rgba(81, 155, 192, 0.9), rgba(40, 113, 42, 0.8)), url('https://images.unsplash.com/photo-1484480974693-6ca0a78fb36b?auto=format&fit=crop&q=80'); background-size: cover; padding: 40px; display: flex; flex-direction: column; justify-content: center; color: white; }
        .auth-right { flex: 1; padding: 50px; display: flex; flex-direction: column; justify-content: center; }
        
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; margin-bottom: 8px; font-size: 0.9rem; color: var(--text-light); }
        .form-group input, .form-group textarea, .form-group select { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; outline: none; transition: 0.3s; }
        .form-group input:focus, .form-group textarea:focus { border-color: var(--primary); }
        
        #app-container { max-width: 1200px; margin: 0 auto; padding: 20px; min-height: 100vh; display: flex; flex-direction: column; }
        
        header { display: flex; justify-content: space-between; align-items: center; padding: 15px 25px; background: white; border-radius: var(--radius); box-shadow: var(--shadow); margin-bottom: 20px; }
        .user-info { display: flex; align-items: center; gap: 15px; }
        .user-badge { background: #ccc; color: #555; padding: 2px 8px; border-radius: 4px; font-size: 10px; font-weight: bold; text-transform: uppercase; }
        .badge-pro { background: #f1c40f; color: #333; }
        .header-actions { display: flex; align-items: center; gap: 10px; }

        .nav-tabs { display: flex; background: white; padding: 10px; border-radius: var(--radius); box-shadow: var(--shadow); margin-bottom: 20px; gap: 10px; overflow-x: auto; }
        .nav-item { flex: 1; padding: 12px; text-align: center; cursor: pointer; border-radius: 8px; color: var(--text-light); font-weight: 500; white-space: nowrap; transition: 0.3s; }
        .nav-item.active { background-color: var(--accent); color: var(--secondary); font-weight: 700; }
        
        .content-section { background: white; border-radius: var(--radius); box-shadow: var(--shadow); padding: 25px; flex-grow: 1; animation: fadeIn 0.4s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* --- TASK LIST --- */
        .task-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 10px; }
        .filter-group { display: flex; background: #f0f0f0; border-radius: 20px; padding: 4px; }
        .filter-btn { padding: 6px 16px; border-radius: 16px; border: none; background: transparent; cursor: pointer; font-size: 13px; color: var(--text-light); }
        .filter-btn.active { background: white; color: var(--primary); box-shadow: 0 2px 5px rgba(0,0,0,0.05); }

        .task-list { list-style: none; }
        .task-item { display: flex; align-items: flex-start; padding: 15px; border-bottom: 1px solid #eee; transition: 0.2s; }
        .task-item:hover { background-color: #f9f9f9; }
        .task-checkbox { width: 20px; height: 20px; margin-right: 15px; margin-top: 5px; accent-color: var(--secondary); cursor: pointer; }
        
        .task-content { flex: 1; }
        .task-title { font-weight: 600; font-size: 1rem; color: var(--text-dark); }
        .task-desc { font-size: 0.85rem; color: #666; margin-top: 4px; line-height: 1.4; }
        .task-meta { display: flex; align-items: center; gap: 10px; margin-top: 8px; font-size: 0.8rem; color: #999; }
        .task-item.completed .task-title { text-decoration: line-through; color: #aaa; }
        .task-actions { display: flex; gap: 5px; margin-left: 10px; }

        /* --- POMODORO --- */
        .pomodoro-container { text-align: center; padding: 20px; }
        .timer-display { width: 280px; height: 280px; background: linear-gradient(135deg, #e0f7fa, #b3d3d9); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 30px auto; border: 8px solid white; box-shadow: 0 10px 30px rgba(81, 155, 192, 0.2); }
        .time-text { font-size: 4rem; font-weight: 700; color: var(--secondary); }
        
        .ambient-selector { margin-top: 20px; display: inline-block; background: #f5f5f5; padding: 10px 20px; border-radius: 20px; }
        .ambient-label { font-size: 0.9rem; color: var(--text-light); margin-right: 10px; }
        #ambient-select { padding: 5px 10px; border-radius: 8px; border: 1px solid #ddd; outline: none; }

        /* --- STATS --- */
        .stats-controls { display: flex; justify-content: center; margin-bottom: 25px; gap: 10px; }
        .stat-period-btn { padding: 8px 16px; background: #eef5f7; border: none; border-radius: 20px; font-size: 0.9rem; color: #666; cursor: pointer; }
        .stat-period-btn.active { background: var(--primary); color: white; }

        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 20px; }
        .stat-card { background: #f8fbfd; padding: 20px; border-radius: 12px; border-left: 4px solid var(--primary); }
        .stat-card h3 { font-size: 2.5rem; color: var(--text-dark); margin: 10px 0; }
        .stat-card p { font-size: 0.9rem; color: #666; }

        .pro-chart-container { display: none; margin-top: 30px; }
        .chart-bars { display: flex; align-items: flex-end; justify-content: space-between; height: 200px; padding-bottom: 10px; border-bottom: 2px solid #eee; }
        .chart-bar { width: 12%; background: var(--secondary); border-radius: 5px 5px 0 0; position: relative; transition: height 0.5s; }
        .chart-bar span { position: absolute; bottom: -25px; left: 50%; transform: translateX(-50%); font-size: 12px; color: #666; }
        
        .lock-overlay { position: relative; height: 200px; background: #f9f9f9; display: flex; flex-direction: column; align-items: center; justify-content: center; border-radius: 12px; text-align: center; border: 1px dashed #ccc; }

        /* --- MODAL --- */
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 1000; }
        .modal-content { background: white; padding: 30px; border-radius: 16px; width: 450px; max-width: 90%; animation: popUp 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        @keyframes popUp { from { opacity: 0; transform: scale(0.8); } to { opacity: 1; transform: scale(1); } }

        /* GUIDE MODAL STYLES */
        .guide-modal-content { width: 700px; max-width: 95%; max-height: 90vh; overflow-y: auto; padding: 40px; }
        .guide-item { display: flex; gap: 20px; margin-bottom: 25px; background: #fff; padding: 15px; border-radius: 12px; border: 1px solid #f0f0f0; }
        .guide-icon { width: 50px; height: 50px; background: var(--secondary); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.2rem; flex-shrink: 0; }
        .guide-text h4 { color: var(--text-dark); margin-bottom: 5px; font-size: 1.1rem; }
        .guide-text p { color: var(--text-light); font-size: 0.9rem; margin-bottom: 8px; line-height: 1.5; }
        .guide-tips { font-size: 0.85rem; color: #555; background: #fffde7; padding: 8px 12px; border-radius: 6px; display: inline-block; margin-top: 5px; }
        .guide-tips ul { padding-left: 20px; margin-top: 5px; list-style-type: disc; }
        .guide-tips li { margin-bottom: 2px; }
        
        .pomodoro-steps-box { background: #eafcf0; padding: 20px; border-radius: 12px; margin-top: 30px; border: 1px solid #c8e6c9; }
        .pomodoro-steps { display: grid; grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); gap: 15px; text-align: center; margin-top: 15px; }
        .step-item { background: white; padding: 15px; border-radius: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .step-icon { font-size: 1.5rem; color: var(--text-dark); margin-bottom: 8px; display: block; }
        .step-label { font-size: 0.8rem; font-weight: 500; color: #555; }

        /* Responsive */
        @media (max-width: 768px) {
            .auth-card { flex-direction: column; }
            .auth-left { display: none; }
            .task-header { flex-direction: column; align-items: stretch; }
            .filter-group { justify-content: center; }
            .guide-item { flex-direction: column; }
            .guide-icon { margin-bottom: 10px; }
        }
    </style>
</head>
<body>

    <!-- CONTAINER 1: LOGIN & SIGNUP -->
    <div id="auth-container">
        <div class="auth-card">
            <div class="auth-left">
                <h1>Kelola Waktumu,<br>Capai Targetmu.</h1>
                <p>Platform Manajemen Waktu dengan Teknik Pomodoro</p>
            </div>
            <div class="auth-right">
                <h2 style="color:var(--primary); margin-bottom:10px;">TimeTask</h2>
                <!-- Login Form -->
                <form id="login-form">
                    <h3>Masuk</h3>
                    <p style="color:#888; font-size:0.9rem; margin-bottom:20px;">Selamat datang kembali!</p>
                    <div class="form-group">
                        <label>Email</label>
                        <input type="email" id="login-email" placeholder="email@contoh.com" required>
                    </div>
                    <div class="form-group">
                        <label>Password</label>
                        <input type="password" id="login-password" required>
                    </div>
                    <button type="submit" class="btn btn-secondary" style="width:100%">Masuk</button>
                    <p style="text-align:center; margin-top:15px; font-size:0.9rem;">
                        Belum punya akun? <a href="#" onclick="toggleAuth('register')" style="color:var(--primary)">Daftar</a>
                    </p>
                </form>
                <!-- Register Form -->
                <form id="register-form" class="hidden">
                    <h3>Daftar Baru</h3>
                    <p style="color:#888; font-size:0.9rem; margin-bottom:20px;">Mulai perjalanan produktif Anda.</p>
                    <div class="form-group">
                        <label>Nama</label>
                        <input type="text" id="reg-username" required>
                    </div>
                    <div class="form-group">
                        <label>Email</label>
                        <input type="email" id="reg-email" required>
                    </div>
                    <div class="form-group">
                        <label>Password</label>
                        <input type="password" id="reg-password" required>
                    </div>
                    <button type="submit" class="btn btn-primary" style="width:100%">Daftar</button>
                    <p style="text-align:center; margin-top:15px; font-size:0.9rem;">
                        Sudah punya akun? <a href="#" onclick="toggleAuth('login')" style="color:var(--primary)">Masuk</a>
                    </p>
                </form>
            </div>
        </div>
    </div>

    <!-- CONTAINER 2: DASHBOARD -->
    <div id="app-container" class="hidden">
        <!-- Header -->
        <header>
            <div class="user-info">
                <!-- LOGO USER -->
                <img src="img/logo2.png"
                     alt="Logo" style="width: 45px; height: 45px; object-fit: cover; border-radius: 8px;">
                <div>
                    <h4 id="display-username">Halo, User!</h4>
                    <span id="user-status-badge" class="user-badge">Basic Plan</span>
                </div>
            </div>
            
            <div class="header-actions">
                <!-- HELP BUTTON -->
                <button class="btn-icon" onclick="showGuideModal()" title="Panduan Penggunaan">
                    <i class="fas fa-question-circle" style="font-size: 1.5rem; color: var(--primary);"></i>
                </button>
                
                <button class="btn btn-secondary" id="upgrade-btn-top" onclick="showProModal()">Upgrade Pro</button>
                <button class="btn btn-outline" onclick="logout()">Keluar <i class="fas fa-sign-out-alt"></i></button>
            </div>
        </header>

        <!-- Nav Tabs -->
        <div class="nav-tabs">
            <div class="nav-item active" onclick="switchTab('tasks', this)">Manajemen Tugas</div>
            <div class="nav-item" onclick="switchTab('pomodoro', this)">Pomodoro Timer</div>
            <div class="nav-item" onclick="switchTab('report', this)">Laporan Produktivitas</div>
        </div>

        <!-- 1. MANAJEMEN TUGAS -->
        <section id="tasks" class="content-section">
            <div class="task-header">
                <div>
                    <h3 style="color: var(--primary);">Daftar Tugas</h3>
                    <p style="font-size: 0.9rem; color: #888;"><span id="task-completed-count">0</span> dari <span id="task-total-count">0</span> tugas selesai</p>
                </div>
                <div class="filter-group">
                    <button class="filter-btn active" onclick="filterTasks('all', this)">Semua</button>
                    <button class="filter-btn" onclick="filterTasks('pending', this)">Belum</button>
                    <button class="filter-btn" onclick="filterTasks('completed', this)">Selesai</button>
                </div>
                <button class="btn btn-secondary" onclick="openTaskModal()">+ Tambah Tugas</button>
            </div>

            <!-- Task List -->
            <ul class="task-list" id="task-list-container">
                <!-- Task Items injected by JS -->
            </ul>
        </section>

        <!-- 2. POMODORO -->
        <section id="pomodoro" class="content-section hidden">
            <div class="pomodoro-container">
                <h3 style="color: var(--primary); margin-bottom: 20px;">Pomodoro Timer</h3>
                
                <div class="timer-modes">
                    <button class="btn btn-outline" onclick="setTimerMode(25, this)" class="mode-btn active" style="background:var(--accent); color:var(--secondary); border:none;">Fokus</button>
                    <button class="btn btn-outline" onclick="setTimerMode(5, this)">Istirahat</button>
                    <button class="btn btn-outline" onclick="setTimerMode(15, this)">Istirahat Panjang</button>
                </div>

                <div class="timer-display">
                    <div class="time-text" id="timer-text">25:00</div>
                </div>

                <!-- AMBIENT SOUND (PRO FEATURE) -->
                <div class="ambient-selector">
                    <span class="ambient-label"><i class="fas fa-music"></i> Suara Latar (Pro):</span>
                    <select id="ambient-select" onchange="handleAmbientChange(this)">
                        <option value="none">Tidak Ada</option>
                        <option value="rain">Hujan Rintik</option>
                        <option value="cafe">Suasana Cafe</option>
                        <option value="forest">Hutan Alam</option>
                    </select>
                </div>

                <div class="timer-controls" style="margin-top: 30px;">
                    <button class="btn btn-secondary" id="start-btn" onclick="toggleTimer()"><i class="fas fa-play"></i> Mulai</button>
                    <button class="btn btn-outline" onclick="resetTimer()"><i class="fas fa-redo"></i> Reset</button>
                </div>
            </div>
        </section>

        <!-- 3. LAPORAN -->
        <section id="report" class="content-section hidden">
            <h3 style="color: var(--primary); margin-bottom: 20px;">Laporan Produktivitas</h3>
            
            <div class="stats-controls">
                <button class="stat-period-btn active" onclick="updateStatsPeriod('daily', this)">Hari Ini</button>
                <button class="stat-period-btn" onclick="updateStatsPeriod('weekly', this)">Minggu Ini</button>
                <button class="stat-period-btn" onclick="updateStatsPeriod('monthly', this)">Bulan Ini</button>
            </div>

            <div class="stats-grid">
                <div class="stat-card">
                    <h3 id="stat-tasks">0</h3>
                    <p>Tugas Selesai</p>
                </div>
                <div class="stat-card" style="border-color: var(--secondary);">
                    <h3 id="stat-sessions">0</h3>
                    <p>Sesi Fokus Tuntas</p>
                </div>
            </div>

            <!-- PRO STATS SECTION -->
            <div style="margin-top: 30px;">
                <h4 style="margin-bottom: 15px;">Analisis Grafik Mingguan (Pro)</h4>
                
                <!-- Locked View -->
                <div id="pro-locked-view" class="lock-overlay">
                    <i class="fas fa-lock" style="font-size: 30px; color: var(--secondary); margin-bottom: 10px;"></i>
                    <p style="color:#666">Upgrade ke Pro untuk melihat grafik analisis mingguan.</p>
                    <button class="btn btn-secondary" onclick="showProModal()" style="margin-top: 10px; font-size: 12px;">Buka Akses</button>
                </div>

                <!-- Unlocked View (Chart) -->
                <div id="pro-chart-view" class="pro-chart-container">
                    <div class="chart-bars">
                        <!-- Simple CSS Bars representing data -->
                        <div class="chart-bar" style="height: 40%"><span>Sen</span></div>
                        <div class="chart-bar" style="height: 70%"><span>Sel</span></div>
                        <div class="chart-bar" style="height: 50%"><span>Rab</span></div>
                        <div class="chart-bar" style="height: 85%"><span>Kam</span></div>
                        <div class="chart-bar" style="height: 60%"><span>Jum</span></div>
                        <div class="chart-bar" style="height: 30%"><span>Sab</span></div>
                        <div class="chart-bar" style="height: 20%"><span>Min</span></div>
                    </div>
                    <p style="text-align: center; margin-top: 10px; font-size: 0.8rem; color: #888;">Statistik penyelesaian tugas 7 hari terakhir.</p>
                </div>
            </div>
        </section>
    </div>

    <!-- MODAL: ADD/EDIT TASK -->
    <div id="task-modal" class="modal hidden">
        <div class="modal-content">
            <h3 id="modal-title" style="margin-bottom: 20px;">Tambah Tugas Baru</h3>
            <input type="hidden" id="task-id"> <!-- Hidden ID for Editing -->
            
            <div class="form-group">
                <label>Judul Tugas</label>
                <input type="text" id="task-title" placeholder="Contoh: Belajar Coding">
            </div>
            
            <!-- NEW: DESCRIPTION COLUMN -->
            <div class="form-group">
                <label>Deskripsi (Opsional)</label>
                <textarea id="task-desc" rows="3" placeholder="Tambahkan detail tugas..."></textarea>
            </div>
            
            <div class="form-group">
                <label>Deadline (Opsional)</label>
                <input type="date" id="task-date">
            </div>
            
            <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;">
                <button class="btn btn-outline" onclick="closeModal('task-modal')">Batal</button>
                <button id="btn-save-task" class="btn btn-secondary" onclick="saveTask()">Simpan</button>
            </div>
        </div>
    </div>

    <!-- MODAL: UPGRADE PRO -->
    <div id="pro-modal" class="modal hidden">
        <div class="modal-content" style="text-align: center;">
            <div style="display: flex; justify-content: flex-end;">
                <button onclick="closeModal('pro-modal')" style="background: none; border: none; font-size: 20px; cursor: pointer;">&times;</button>
            </div>
            <i class="fas fa-crown" style="font-size: 40px; color: gold; margin-bottom: 15px;"></i>
            <h2>Upgrade ke TimeTask Pro</h2>
            <p style="color: #666; font-size: 0.9rem;">Fitur eksklusif untuk produktivitas maksimal.</p>
            
            <div class="pro-price">
                <span style="text-decoration: line-through; color: #aaa; font-size: 0.9rem;">Rp 50.000</span><br>
                <strong style="font-size: 1.5rem;">Rp 15.000</strong><br>
                <small>Sekali bayar, akses selamanya</small>
            </div>
            <ul style="text-align: left; margin: 20px 0; font-size: 0.9rem; color: #555; list-style: none;">
                <li style="margin-bottom:8px;"><i class="fas fa-check" style="color:var(--secondary)"></i> Grafik Analisis Mingguan</li>
                <li style="margin-bottom:8px;"><i class="fas fa-check" style="color:var(--secondary)"></i> Suara Ambient (Hujan, Cafe)</li>
                <li><i class="fas fa-check" style="color:var(--secondary)"></i> Pengingat Suara</li>
            </ul>
            <button class="btn btn-secondary" style="width: 100%;" onclick="simulatePayment()">Upgrade Sekarang</button>
        </div>
    </div>

    <!-- MODAL: USER GUIDE (NEW) -->
    <div id="guide-modal" class="modal hidden">
        <div class="modal-content guide-modal-content">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h3>Panduan Penggunaan TimeTask</h3>
                <button onclick="closeModal('guide-modal')" style="background: none; border: none; font-size: 20px; cursor: pointer;">&times;</button>
            </div>

            <!-- Item 1 -->
            <div class="guide-item">
                <div class="guide-icon"><i class="fas fa-check"></i></div>
                <div class="guide-text">
                    <h4>1. Kelola Tugas Anda</h4>
                    <p>Tambahkan semua tugas yang perlu diselesaikan. Tandai tugas yang sudah selesai dan pantau progres Anda.</p>
                </div>
            </div>

            <!-- Item 2 -->
            <div class="guide-item">
                <div class="guide-icon"><i class="fas fa-stopwatch"></i></div>
                <div class="guide-text">
                    <h4>2. Gunakan Pomodoro Timer</h4>
                    <p>Fokus selama 25 menit, lalu istirahat 5 menit. Gunakan tombol 'Reset' untuk mengulang waktu sesuai mode.</p>
                </div>
            </div>

            <!-- Item 3 -->
            <div class="guide-item">
                <div class="guide-icon"><i class="fas fa-chart-bar"></i></div>
                <div class="guide-text">
                    <h4>3. Pantau Produktivitas</h4>
                    <p>Gunakan tab 'Hari Ini', 'Minggu Ini', atau 'Bulan Ini' di menu Laporan untuk melihat performa Anda.</p>
                </div>
            </div>

            <!-- Item 4 -->
            <div class="guide-item">
                <div class="guide-icon"><i class="fas fa-crown"></i></div>
                <div class="guide-text">
                    <h4>4. Fitur Pro (Audio)</h4>
                    <p>Putar suara hujan atau suasana cafe saat timer berjalan untuk meningkatkan fokus.</p>
                </div>
            </div>
            
            <button class="btn btn-secondary" onclick="closeModal('guide-modal')" style="width: 100%; margin-top: 20px;">Mulai Gunakan TimeTask</button>
        </div>
    </div>

    <!-- FIREBASE LOGIC -->
    <script type="module">
        // --- 1. CONFIGURATION ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut, updateProfile } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, where, onSnapshot, doc, updateDoc, deleteDoc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";

        // === FIREBASE CONFIG ===
        const firebaseConfig = {
            apiKey: "AIzaSyAwFQ6HgWYU0xLBdQQdQLhcrWAnzxNpH_4",
            authDomain: "timetask-d6fcb.firebaseapp.com",
            projectId: "timetask-d6fcb",
            storageBucket: "timetask-d6fcb.firebasestorage.app",
            messagingSenderId: "634201022890",
            appId: "1:634201022890:web:68e5dc0738ffd140034bd3",
            measurementId: "G-0TG6HG0GTZ"
        };

        // Init Firebase
        let app, auth, db;
        try {
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
        } catch(e) { console.error("Firebase config error", e); }

        // --- GLOBAL STATE ---
        let currentUser = null;
        let isProUser = false;
        let tasks = [];
        let filter = 'all';
        let statsPeriod = 'daily'; // daily, weekly, monthly

        // --- AUTH LOGIC ---
        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                document.getElementById('auth-container').classList.add('hidden');
                document.getElementById('app-container').classList.remove('hidden');
                document.getElementById('display-username').innerText = `Halo, ${user.displayName || 'User'}!`;
                document.getElementById('user-avatar').src = `https://ui-avatars.com/api/?name=${user.displayName || 'User'}&background=random`;
                
                checkProStatus(user.uid);
                loadTasks(user.uid);
                requestNotificationPermission();
            } else {
                currentUser = null;
                isProUser = false;
                document.getElementById('auth-container').classList.remove('hidden');
                document.getElementById('app-container').classList.add('hidden');
            }
        });

        // Check Pro Status & Update UI
        async function checkProStatus(uid) {
            try {
                const docSnap = await getDoc(doc(db, "users", uid));
                if (docSnap.exists() && docSnap.data().isPro) {
                    isProUser = true;
                    const badge = document.getElementById('user-status-badge');
                    badge.innerText = "PRO MEMBER";
                    badge.classList.add('badge-pro');
                    document.getElementById('upgrade-btn-top').classList.add('hidden');
                    
                    document.getElementById('pro-locked-view').classList.add('hidden');
                    document.getElementById('pro-chart-view').style.display = 'block';
                }
            } catch(e) { console.log("Pro check error", e); }
        }

        // --- CRUD TUGAS ---

        window.openTaskModal = (id = null) => {
            document.getElementById('task-modal').classList.remove('hidden');
            const titleInput = document.getElementById('task-title');
            const descInput = document.getElementById('task-desc');
            const dateInput = document.getElementById('task-date');
            const hiddenId = document.getElementById('task-id');
            const modalTitle = document.getElementById('modal-title');
            const btnSave = document.getElementById('btn-save-task');

            if (id) {
                const task = tasks.find(t => t.id === id);
                modalTitle.innerText = "Edit Tugas";
                titleInput.value = task.title;
                descInput.value = task.description || "";
                dateInput.value = task.dueDate || "";
                hiddenId.value = id;
                btnSave.innerText = "Perbarui";
            } else {
                modalTitle.innerText = "Tambah Tugas Baru";
                titleInput.value = "";
                descInput.value = "";
                dateInput.value = "";
                hiddenId.value = "";
                btnSave.innerText = "Simpan";
            }
        };

        window.saveTask = async () => {
            const title = document.getElementById('task-title').value;
            const desc = document.getElementById('task-desc').value;
            const date = document.getElementById('task-date').value;
            const id = document.getElementById('task-id').value;

            if (!title) return alert("Judul tugas wajib diisi!");

            const btn = document.getElementById('btn-save-task');
            btn.innerText = "Menyimpan...";
            btn.disabled = true;

            try {
                if (id) {
                    await updateDoc(doc(db, "tasks", id), {
                        title: title, description: desc, dueDate: date
                    });
                } else {
                    await addDoc(collection(db, "tasks"), {
                        uid: currentUser.uid,
                        title: title, description: desc, dueDate: date,
                        completed: false,
                        createdAt: new Date().toISOString()
                    });
                }
                closeModal('task-modal');
            } catch(e) {
                alert("Gagal menyimpan: " + e.message);
            } finally {
                btn.innerText = "Simpan";
                btn.disabled = false;
            }
        };

        window.deleteTask = async (id) => {
            if (confirm("Hapus tugas ini?")) {
                await deleteDoc(doc(db, "tasks", id));
            }
        };

        // UPDATE STATUS & COMPLETED AT
        window.toggleTaskStatus = async (id, currentStatus) => {
            const newStatus = !currentStatus;
            const dataToUpdate = { completed: newStatus };
            
            // Jika selesai, simpan tanggal selesai untuk statistik
            if (newStatus) {
                dataToUpdate.completedAt = new Date().toISOString();
            } else {
                dataToUpdate.completedAt = null;
            }

            await updateDoc(doc(db, "tasks", id), dataToUpdate);
        };

        function loadTasks(uid) {
            const q = query(collection(db, "tasks"), where("uid", "==", uid));
            onSnapshot(q, (snapshot) => {
                tasks = [];
                snapshot.forEach(doc => tasks.push({ id: doc.id, ...doc.data() }));
                renderTasks();
                calculateStats(); // Recalculate stats when data changes
                checkReminders();
            });
        }

        function renderTasks() {
            const container = document.getElementById('task-list-container');
            container.innerHTML = "";
            
            let filtered = tasks;
            if (filter === 'pending') filtered = tasks.filter(t => !t.completed);
            if (filter === 'completed') filtered = tasks.filter(t => t.completed);

            if (filtered.length === 0) {
                container.innerHTML = `<li style="text-align:center; padding:30px; color:#999;">Tidak ada tugas.</li>`;
                return;
            }

            filtered.forEach(task => {
                const li = document.createElement('li');
                li.className = `task-item ${task.completed ? 'completed' : ''}`;
                li.innerHTML = `
                    <input type="checkbox" class="task-checkbox" ${task.completed ? 'checked' : ''} onchange="toggleTaskStatus('${task.id}', ${task.completed})">
                    <div class="task-content">
                        <div class="task-title">${task.title}</div>
                        ${task.description ? `<div class="task-desc">${task.description}</div>` : ''}
                        ${task.dueDate ? `<div class="task-meta"><i class="far fa-calendar"></i> ${task.dueDate}</div>` : ''}
                    </div>
                    <div class="task-actions">
                        <button class="btn-icon" onclick="openTaskModal('${task.id}')"><i class="fas fa-pencil-alt"></i></button>
                        <button class="btn-icon delete" onclick="deleteTask('${task.id}')"><i class="fas fa-trash"></i></button>
                    </div>
                `;
                container.appendChild(li);
            });
            
            document.getElementById('task-total-count').innerText = tasks.length;
            document.getElementById('task-completed-count').innerText = tasks.filter(t => t.completed).length;
        }

        function requestNotificationPermission() {
            if ("Notification" in window && Notification.permission !== "granted") {
                Notification.requestPermission();
            }
        }

        function checkReminders() {
            if (!("Notification" in window) || Notification.permission !== "granted") return;
            const today = new Date().toISOString().split('T')[0];
            tasks.forEach(task => {
                if (!task.completed && task.dueDate === today) {
                    // Logic to avoid spamming notification in real app needed here
                }
            });
        }

        // --- POMODORO & AUDIO SYSTEM ---
        
        let timerInterval;
        let currentModeDuration = 25 * 60; // FIX: Variabel untuk menyimpan durasi mode aktif
        let timeLeft = 25 * 60;
        let isRunning = false;
        
        // AUDIO RESOURCES (Local Folder)
        // Pastikan Anda membuat folder bernama 'audio' di lokasi yang sama dengan file HTML ini
        // Lalu masukkan file mp3 dengan nama yang sesuai.
        const audioResources = {
            rain: "audio/rain.mp3",
            cafe: "audio/cafe.mp3",
            forest: "audio/forest.mp3"
        };
        const ambientAudio = new Audio();
        ambientAudio.loop = true; // Pastikan audio looping

        window.toggleTimer = () => {
            const btn = document.getElementById('start-btn');
            if (isRunning) {
                clearInterval(timerInterval);
                btn.innerHTML = '<i class="fas fa-play"></i> Lanjutkan';
                isRunning = false;
                ambientAudio.pause(); // Pause audio when timer pauses
            } else {
                timerInterval = setInterval(() => {
                    timeLeft--;
                    updateTimerDisplay();
                    if(timeLeft <= 0) {
                        clearInterval(timerInterval);
                        isRunning = false;
                        btn.innerHTML = '<i class="fas fa-play"></i> Mulai';
                        ambientAudio.pause();
                        alert("Waktu habis!");
                        // Increment session count logic would go here
                    }
                }, 1000);
                btn.innerHTML = '<i class="fas fa-pause"></i> Pause';
                isRunning = true;
                
                // Resume audio if selected (and paused previously)
                if(document.getElementById('ambient-select').value !== 'none' && isProUser) {
                    ambientAudio.play().catch(e => console.log("Audio play blocked", e));
                }
            }
        };

        window.resetTimer = () => {
            clearInterval(timerInterval);
            isRunning = false;
            // FIX: Reset ke currentModeDuration, bukan hardcode 25
            timeLeft = currentModeDuration; 
            updateTimerDisplay();
            document.getElementById('start-btn').innerHTML = '<i class="fas fa-play"></i> Mulai';
            
            // Stop audio on reset
            ambientAudio.pause();
            ambientAudio.currentTime = 0;
        };

        window.setTimerMode = (min, btnElement) => {
            // Update UI buttons
            const buttons = document.querySelectorAll('.timer-modes button');
            buttons.forEach(b => {
                b.style.background = 'transparent'; 
                b.style.color = 'var(--primary)';
                b.style.border = '1px solid var(--primary)';
            });
            if(btnElement) {
                btnElement.style.background = 'var(--accent)';
                btnElement.style.color = 'var(--secondary)';
                btnElement.style.border = 'none';
            }

            clearInterval(timerInterval);
            isRunning = false;
            
            // FIX: Set durasi baru sebagai default untuk reset
            currentModeDuration = min * 60; 
            timeLeft = currentModeDuration;
            
            updateTimerDisplay();
            document.getElementById('start-btn').innerHTML = '<i class="fas fa-play"></i> Mulai';
            
            // Stop audio when changing modes (optional, keeps it clean)
            ambientAudio.pause();
        };

        window.handleAmbientChange = (select) => {
            if (!isProUser && select.value !== 'none') {
                select.value = 'none';
                showProModal();
                return;
            }

            if (select.value === 'none') {
                ambientAudio.pause();
                ambientAudio.src = "";
            } else {
                ambientAudio.src = audioResources[select.value];
                // PERUBAHAN DI SINI: Langsung play tanpa cek isRunning
                ambientAudio.play().catch(e => {
                    console.log("Autoplay prevented", e);
                    // Menambahkan penanganan error jika file tidak ditemukan
                    if (e.name === 'NotSupportedError' || e.name === 'error') {
                         alert("File audio tidak ditemukan. Pastikan folder 'audio' ada dan berisi file mp3 yang benar.");
                    }
                });
            }
        };

        function updateTimerDisplay() {
            const m = Math.floor(timeLeft / 60).toString().padStart(2, '0');
            const s = (timeLeft % 60).toString().padStart(2, '0');
            document.getElementById('timer-text').innerText = `${m}:${s}`;
        }

        // --- STATS SYSTEM (Day, Week, Month) - UPDATED ---
        
        window.updateStatsPeriod = (period, btn) => {
            statsPeriod = period;
            document.querySelectorAll('.stat-period-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            calculateStats();
        };

        function calculateStats() {
            const now = new Date();
            
            // 1. Start of Day (00:00 Local)
            const startOfDay = new Date(now);
            startOfDay.setHours(0,0,0,0);
            
            // 2. Start of Week (Monday 00:00 Local)
            const startOfWeek = new Date(now);
            const day = startOfWeek.getDay(); // 0 (Sun) to 6 (Sat)
            const diff = startOfWeek.getDate() - day + (day === 0 ? -6 : 1); // Adjust when day is Sunday
            startOfWeek.setDate(diff);
            startOfWeek.setHours(0,0,0,0);

            // 3. Start of Month (1st 00:00 Local)
            const startOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);
            startOfMonth.setHours(0,0,0,0);

            let completedCount = 0;

            tasks.forEach(task => {
                if (task.completed && task.completedAt) {
                    const taskDate = new Date(task.completedAt);
                    
                    if (statsPeriod === 'daily') {
                        if (taskDate >= startOfDay) completedCount++;
                    } else if (statsPeriod === 'weekly') {
                        if (taskDate >= startOfWeek) completedCount++;
                    } else if (statsPeriod === 'monthly') {
                        if (taskDate >= startOfMonth) completedCount++;
                    }
                }
            });
            
            document.getElementById('stat-tasks').innerText = completedCount;
            // Note: Session stats logic placeholder
            document.getElementById('stat-sessions').innerText = isRunning ? "1 (Aktif)" : "0"; 
        }

        // --- UTILS ---
        window.filterTasks = (type, btn) => {
            filter = type;
            document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            renderTasks();
        };

        window.toggleAuth = (view) => {
            document.getElementById('login-form').classList.toggle('hidden', view === 'register');
            document.getElementById('register-form').classList.toggle('hidden', view === 'login');
        };

        window.switchTab = (id, el) => {
            document.querySelectorAll('.content-section').forEach(s => s.classList.add('hidden'));
            document.getElementById(id).classList.remove('hidden');
            document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
            el.classList.add('active');
        };

        window.showProModal = () => document.getElementById('pro-modal').classList.remove('hidden');
        window.showGuideModal = () => document.getElementById('guide-modal').classList.remove('hidden');
        window.closeModal = (id) => document.getElementById(id).classList.add('hidden');
        
        window.logout = () => signOut(auth).then(() => window.location.reload());

        // FIX: Instant Upgrade Logic (Updated to be more robust)
        window.simulatePayment = async () => {
            const btn = document.querySelector('#pro-modal .btn-secondary');
            btn.innerText = "Memproses...";
            btn.disabled = true;

            try {
                if(currentUser) {
                    // 1. Update Firestore
                    // MENGGUNAKAN setDoc dengan merge: true agar jika dokumen belum ada, akan dibuat otomatis
                    // Ini memperbaiki error "Document not found" saat updateDoc
                    await setDoc(doc(db, "users", currentUser.uid), { isPro: true }, { merge: true });
                    
                    // 2. Update UI INSTANTLY (Don't wait for snapshot)
                    isProUser = true;
                    
                    // Update Badge
                    const badge = document.getElementById('user-status-badge');
                    badge.innerText = "PRO MEMBER";
                    badge.classList.add('badge-pro');
                    document.getElementById('upgrade-btn-top').classList.add('hidden');
                    
                    // Unlock Stats
                    document.getElementById('pro-locked-view').classList.add('hidden');
                    document.getElementById('pro-chart-view').style.display = 'block';

                    alert("Upgrade Berhasil! Fitur Pro kini aktif.");
                } else {
                    alert("Silakan login terlebih dahulu.");
                }
                closeModal('pro-modal');
            } catch(e) {
                console.error(e);
                alert("Gagal upgrade: " + e.message); // Tampilkan pesan error detail
            } finally {
                btn.innerText = "Upgrade Sekarang";
                btn.disabled = false;
            }
        };

        // Auth Form Listeners
        document.getElementById('login-form').addEventListener('submit', (e) => {
            e.preventDefault();
            signInWithEmailAndPassword(auth, 
                document.getElementById('login-email').value, 
                document.getElementById('login-password').value
            ).catch(err => alert("Login gagal: " + err.message));
        });

        document.getElementById('register-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const username = document.getElementById('reg-username').value;
            createUserWithEmailAndPassword(auth, 
                document.getElementById('reg-email').value, 
                document.getElementById('reg-password').value
            ).then((cred) => {
                updateProfile(cred.user, { displayName: username });
                setDoc(doc(db, "users", cred.user.uid), { 
                    username, email: cred.user.email, isPro: false 
                });
            }).catch(err => alert("Register gagal: " + err.message));
        });

    </script>
</body>
</html>
