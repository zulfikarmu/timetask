<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Time Task - Pomodoro untuk Produktivitas</title>
    <!-- Muat Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Muat Ikon (Heroicons) -->
    <script src="https://unpkg.com/heroicons@2.1.3/24/outline/dist/heroicons.js"></script>
    <!-- Font Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Style untuk tautan navigasi aktif */
        .nav-active {
            background-color: #e0f2fe; /* light-blue-100 */
            color: #0284c7; /* light-blue-700 */
            font-weight: 600;
        }
        .nav-active svg {
            color: #0284c7; /* light-blue-700 */
        }
        /* Animasi sederhana untuk memuat */
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: .5; }
        }
        .loading-pulse {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }

        /* Ukuran ikon kustom */
        .icon-sm { width: 20px; height: 20px; }
        .icon-md { width: 24px; height: 24px; }
        .icon-lg { width: 32px; height: 32px; }
    </style>
</head>
<body class="bg-gray-100">

    <div class="flex h-screen overflow-hidden">
        <!-- Sidebar Navigasi -->
        <aside class="w-64 bg-white p-5 flex flex-col flex-shrink-0 border-r">
            <!-- Logo -->
            <div class="flex items-center gap-2 mb-8">
                <a class="navbar-brand fw-bold fs-4" href="index.html"> 
                    <img style="width: 50px;" src="img/logo.png" alt="logo">
                </a>
                <a href="index.html">
                    <span class="text-2xl font-bold text-gray-800">TimeTask</span>
                </a>
            </div>

            <!-- Tambah Tugas -->
            <button class="w-full bg-cyan-600 text-white py-2.5 px-4 rounded-lg font-semibold flex items-center justify-center gap-2 hover:bg-cyan-700 transition duration-200">
                <svg class="icon-sm" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" />
                </svg>
                Tambah Tugas
            </button>

            <!-- Menu Utama -->
            <nav class="mt-8 flex-1">
                <h3 class="text-xs font-semibold text-gray-400 uppercase tracking-wider mb-3">Fitur Utama</h3>
                <ul class="space-y-1">
                    <li>
                        <a href="#" data-view="tasks" class="nav-item flex items-center gap-3 px-3 py-2.5 rounded-lg text-gray-600 hover:bg-gray-100 nav-active">
                            <svg class="icon-sm" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M4.5 12.75l6 6 9-13.5" />
                            </svg>
                            Task Manager
                        </a>
                    </li>
                    <li>
                        <a href="#" data-view="pomodoro" class="nav-item flex items-center gap-3 px-3 py-2.5 rounded-lg text-gray-600 hover:bg-gray-100">
                             <svg class="icon-sm" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M12 6v6h4.5m4.5 0a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" />
                            </svg>
                            Pomodoro Timer
                        </a>
                    </li>
                    <li>
                        <a href="#" data-view="progress" class="nav-item flex items-center gap-3 px-3 py-2.5 rounded-lg text-gray-600 hover:bg-gray-100">
                            <svg class="icon-sm" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M3.75 3v11.25A2.25 2.25 0 0 0 6 16.5h12M3.75 3h-1.5m1.5 0h16.5m0 0h1.5m-1.5 0v11.25A2.25 2.25 0 0 1 18 16.5h-12a2.25 2.25 0 0 1-2.25-2.25V3m11.25 0c0 1.5-1.125 2.625-2.5 2.625S10 4.5 10 3m0 0a2.5 2.5 0 0 0-5 0m5 0a2.5 2.5 0 0 1 5 0m0 0c0 1.5 1.125 2.625 2.5 2.625s2.5-1.125 2.5-2.625" />
                            </svg>
                            Progress Tracking
                        </a>
                    </li>
                </ul>

                <!-- Proyek -->
                <h3 class="text-xs font-semibold text-gray-400 uppercase tracking-wider mt-8 mb-3">Proyek</h3>
                <ul class="space-y-1" id="project-list">
                    <!-- Daftar proyek dari Firestore akan muncul di sini -->
                    <li class="p-3 text-sm text-gray-400">Memuat proyek...</li>
                </ul>
            </nav>

            <!-- Pengaturan -->
            <div>
                 <a href="#" data-view="settings" class="nav-item flex items-center gap-3 px-3 py-2.5 rounded-lg text-gray-600 hover:bg-gray-100">
                    <svg class="icon-sm" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M10.5 6h9.75M10.5 6a1.5 1.5 0 1 1-3 0m3 0a1.5 1.5 0 1 0-3 0M3.75 6H7.5m3 12h9.75m-9.75 0a1.5 1.5 0 0 1-3 0m3 0a1.5 1.5 0 0 0-3 0M3.75 18H7.5m3-6h9.75m-9.75 0a1.5 1.5 0 0 1-3 0m3 0a1.5 1.5 0 0 0-3 0M3.75 12H7.5" />
                    </svg>
                    Pengaturan
                </a>
                <div id="user-info" class="p-3 text-xs text-gray-400 break-words">
                    Memuat info pengguna...
                </div>
            </div>
        </aside>

        <!-- Konten Utama -->
        <div class="flex-1 flex flex-col overflow-hidden">
            <!-- Header Atas -->
            <header class="bg-white border-b p-4 flex justify-between items-center">
                <!-- Search -->
                <div class="relative">
                    <input type="text" placeholder="Cari tugas, proyek, atau tag..." class="bg-gray-100 rounded-lg pl-10 pr-4 py-2 w-96 text-sm focus:outline-none focus:ring-2 focus:ring-cyan-500">
                    <svg class="icon-sm text-gray-400 absolute left-3 top-1/2 -translate-y-1/2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-5.197-5.197m0 0A7.5 7.5 0 1 0 5.196 5.196a7.5 7.5 0 0 0 10.607 10.607Z" />
                    </svg>
                </div>
                <!-- Ikon Kanan -->
                <div class="flex items-center gap-5">
                    <button class="text-gray-500 hover:text-gray-800">
                        <svg class="icon-md" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M10.5 6h9.75M10.5 6a1.5 1.5 0 1 1-3 0m3 0a1.5 1.5 0 1 0-3 0M3.75 6H7.5m3 12h9.75m-9.75 0a1.5 1.5 0 0 1-3 0m3 0a1.5 1.5 0 0 0-3 0M3.75 18H7.5m3-6h9.75m-9.75 0a1.5 1.5 0 0 1-3 0m3 0a1.5 1.5 0 0 0-3 0M3.75 12H7.5" />
                        </svg>
                    </button>
                    <button class="text-gray-500 hover:text-gray-800 relative">
                        <svg class="icon-md" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M14.857 17.082a23.848 23.848 0 0 0 5.454-1.31A8.967 8.967 0 0 1 18 9.75V9A6 6 0 0 0 6 9v.75a8.967 8.967 0 0 1-2.312 6.022c1.733.64 3.56 1.085 5.455 1.31m5.714 0a24.255 24.255 0 0 1-5.714 0m5.714 0a3 3 0 1 1-5.714 0" />
                        </svg>
                        <span class="absolute top-0 right-0 w-2 h-2 bg-red-500 rounded-full"></span>
                    </button>
                    <!-- User Avatar -->
                    <button class="w-8 h-8 bg-gray-300 rounded-full overflow-hidden">
                         <img src="https://placehold.co/32x32/E0E7FF/6366F1?text=A" alt="User Avatar">
                    </button>
                </div>
            </header>

            <!-- Area Konten Dinamis -->
            <main class="flex-1 overflow-y-auto p-8" id="content-area">
                <!-- Konten akan dimuat oleh JavaScript -->
            </main>
        </div>

        <!-- Sidebar Kanan - Pomodoro (Hanya di Tampilan Task Manager) -->
        <aside id="pomodoro-sidebar" class="w-80 bg-white p-6 flex-shrink-0 border-l flex flex-col">
            <!-- Pilihan Mode -->
            <div class="bg-gray-100 rounded-lg p-1 flex justify-between items-center">
                <button data-mode="fokus" class="pomodoro-mode-btn w-1/3 py-2 rounded-md text-sm font-semibold bg-white text-cyan-700 shadow-sm">Fokus</button>
                <button data-mode="istirahat" class="pomodoro-mode-btn w-1/3 py-2 rounded-md text-sm font-semibold text-gray-600">Istirahat</button>
                <button data-mode="panjang" class="pomodoro-mode-btn w-1/3 py-2 rounded-md text-sm font-semibold text-gray-600">Istirahat Panjang</button>
            </div>

            <!-- Timer -->
            <div class="flex flex-col items-center justify-center my-10 flex-1">
                <h1 id="timer-display" class="text-7xl font-bold text-gray-800">25:00</h1>
                <div class="mt-4 text-sm text-gray-500">
                    <span id="pomodoro-count">0</span> sesi selesai
                </div>
                <!-- Progress Bar Sesi (contoh) -->
                <div class="w-full bg-gray-200 rounded-full h-1.5 mt-4">
                    <div id="timer-progress" class="bg-cyan-600 h-1.5 rounded-full" style="width: 0%"></div>
                </div>
            </div>

            <!-- Kontrol -->
            <div class="flex items-center justify-center gap-4">
                <button id="start-pause-btn" class="bg-cyan-600 text-white py-3 px-8 rounded-lg font-semibold text-lg hover:bg-cyan-700 transition">
                    Mulai
                </button>
                <button id="skip-btn" class="w-12 h-12 flex items-center justify-center bg-gray-100 rounded-lg text-gray-600 hover:bg-gray-200">
                    <svg class="icon-sm" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" d="m5.25 4.5 7.5 7.5-7.5 7.5m6-15 7.5 7.5-7.5 7.5" />
                    </svg>
                </button>
                <button id="reset-btn" class="w-12 h-12 flex items-center justify-center bg-gray-100 rounded-lg text-gray-600 hover:bg-gray-200">
                    <svg class="icon-sm" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M16.023 9.348h4.992v-.001M2.985 19.644v-4.992m0 0h4.992m-4.993 0 3.181 3.183a8.25 8.25 0 0 0 13.803-3.7M4.031 9.865a8.25 8.25 0 0 1 13.803-3.7l3.181 3.182m0-4.991v4.99" />
                    </svg>
                </button>
            </div>

            <!-- Tugas Saat Ini -->
            <div class="mt-8 border-t pt-6">
                <h4 class="text-sm font-semibold text-gray-800">Tugas saat ini:</h4>
                <p id="current-focus-task" class="text-sm text-gray-500 mt-1">Pilih tugas untuk difokuskan</p>
            </div>
        </aside>
    </div>

    <!-- Template untuk Tampilan (dihilangkan dari DOM) -->
    <template id="template-tasks">
        <div>
            <h1 class="text-3xl font-bold text-gray-900">Inbox</h1>
            <p class="text-gray-600 mt-1">Kelola semua tugas yang masuk</p>

            <!-- Tambah Tugas Baru -->
            <div classs="mt-6">
                <form id="add-task-form" class="bg-white rounded-lg p-4 flex items-center gap-4 shadow-sm">
                    <button type="button" class="text-gray-400 hover:text-cyan-600">
                        <svg class="icon-md" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75 11.25 15 15 9.75M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" />
                        </svg>
                    </button>
                    <input type="text" id="new-task-title" placeholder="Tambah tugas baru..." class="flex-1 text-sm focus:outline-none placeholder-gray-500">
                    <button type"submit" class="text-cyan-600 hover:text-cyan-800">
                        <svg class="icon-md" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                           <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v6m3-3H9m12 0a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" />
                        </svg>
                    </button>
                </form>
            </div>

            <!-- Tugas Aktif -->
            <div class="mt-8">
                <h2 class="text-lg font-semibold text-gray-800 mb-4">Tugas Aktif</h2>
                <div id="active-tasks-list" class="space-y-3">
                    <!-- Daftar tugas dari Firestore akan muncul di sini -->
                    <div class="p-4 text-center text-gray-500">Memuat tugas...</div>
                </div>
            </div>
        </div>
    </template>

    <template id="template-task-item">
        <div class="bg-white rounded-lg p-4 flex items-start gap-4 shadow-sm border">
            <button class="task-complete-btn mt-1 text-gray-400 hover:text-green-500">
                <svg class="icon-md" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75 11.25 15 15 9.75M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" />
                </svg>
            </button>
            <div class="flex-1">
                <p class="task-title font-medium text-gray-800">Nama Tugas</p>
                <div class="flex items-center gap-4 mt-1.5 text-xs text-gray-500">
                    <span class="task-due-date flex items-center gap-1">
                        <svg class="icon-sm" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M6.75 3v2.25M17.25 3v2.25M3 18.75V7.5a2.25 2.25 0 0 1 2.25-2.25h13.5A2.25 2.25 0 0 1 21 7.5v11.25m-18 0A2.25 2.25 0 0 0 5.25 21h13.5A2.25 2.25 0 0 0 21 18.75m-18 0v-7.5A2.25 2.25 0 0 1 5.25 9h13.5A2.25 2.25 0 0 1 21 11.25v7.5" /></svg>
                        Hari ini
                    </span>
                    <span class="task-pomodoros flex items-center gap-1">
                        <svg class="icon-sm" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 6v6h4.5m4.5 0a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" /></svg>
                        0 pomodoro
                    </span>
                </div>
                <div class="task-tags mt-2 flex gap-2">
                    <!-- Tags akan ditambahkan di sini -->
                </div>
            </div>
            <button class="task-focus-btn text-gray-400 hover:text-cyan-600">
                <svg class="icon-md" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M15.042 21.672 13.684 16.6m0 0-2.51 2.225.569-9.47 5.227 7.917-3.286-.672ZM12 2.25V4.5m5.834.166-1.591 1.591M20.25 12h-2.25m-1.591 5.834-1.591-1.591M4.5 12H2.25m1.591-5.834L2.25 7.666M12 20.25v-2.25" />
                </svg>
            </button>
        </div>
    </template>

    <template id="template-progress">
        <div>
            <h1 class="text-3xl font-bold text-gray-900">Progress Tracking</h1>
            <p class="text-gray-600 mt-1">Pantau perkembangan produktivitas Anda</p>

            <!-- Stats Utama -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mt-8">
                <!-- Stat Card -->
                <div class="bg-white p-5 rounded-lg shadow-sm border flex items-start gap-4">
                    <div class="p-2.5 bg-green-100 rounded-full">
                        <svg class="icon-md text-green-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75 11.25 15 15 9.75M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" />
                        </svg>
                    </div>
                    <div>
                        <p class="text-sm text-gray-500">Tugas Selesai</p>
                        <p id="stat-tasks-completed" class="text-3xl font-semibold text-gray-800 mt-1">0</p>
                        <p class="text-xs text-green-600 mt-1">+0% dari minggu lalu</p>
                    </div>
                </div>
                <!-- Stat Card -->
                <div class="bg-white p-5 rounded-lg shadow-sm border flex items-start gap-4">
                    <div class="p-2.5 bg-cyan-100 rounded-full">
                        <svg class="icon-md text-cyan-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M12 6v6h4.5m4.5 0a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" />
                        </svg>
                    </div>
                    <div>
                        <p class="text-sm text-gray-500">Pomodoro Selesai</p>
                        <p id="stat-pomodoros-completed" class="text-3xl font-semibold text-gray-800 mt-1">0</p>
                        <p class="text-xs text-green-600 mt-1">+0% dari minggu lalu</p>
                    </div>
                </div>
                <!-- Stat Card -->
                <div class="bg-white p-5 rounded-lg shadow-sm border flex items-start gap-4">
                    <div class="p-2.5 bg-red-100 rounded-full">
                        <svg class="icon-md text-red-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M15.362 5.214A8.252 8.252 0 0 1 12 21 8.25 8.25 0 0 1 6.038 7.047 8.287 8.287 0 0 0 9 9.601a8.983 8.983 0 0 1 3.361-3.867 8.21 8.21 0 0 0 3 .03Z" />
                            <path stroke-linecap="round" stroke-linejoin="round" d="M12 18a3 3 0 0 0 3-3V9.306A9 9 0 0 0 6.168 8.198l.058.059A9 9 0 0 0 12 18Z" />
                    </svg>
                    </div>
                    <div>
                        <p class="text-sm text-gray-500">Hari Berturut-turut</p>
                        <p id="stat-consecutive-days" class="text-3xl font-semibold text-gray-800 mt-1">0</p>
                        <p class="text-xs text-gray-500 mt-1">Pertahankan momentum!</p>
                    </div>
                </div>
                <!-- Stat Card -->
                <div class="bg-white p-5 rounded-lg shadow-sm border flex items-start gap-4">
                    <div class="p-2.5 bg-blue-100 rounded-full">
                        <svg class="icon-md text-blue-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                           <path stroke-linecap="round" stroke-linejoin="round" d="M10.5 6h9.75M10.5 6a1.5 1.5 0 1 1-3 0m3 0a1.5 1.5 0 1 0-3 0M3.75 6H7.5m3 12h9.75m-9.75 0a1.5 1.5 0 0 1-3 0m3 0a1.5 1.5 0 0 0-3 0M3.75 18H7.5m3-6h9.75m-9.75 0a1.5 1.5 0 0 1-3 0m3 0a1.5 1.5 0 0 0-3 0M3.75 12H7.5" />
                        </svg>
                    </div>
                    <div>
                        <p class="text-sm text-gray-500">Target Harian</p>
                        <p id="stat-daily-target" class="text-3xl font-semibold text-gray-800 mt-1">0%</p>
                        <p id="stat-daily-target-ratio" class="text-xs text-gray-500 mt-1">0/20 tugas selesai</p>
                    </div>
                </div>
            </div>

            <!-- Grafik -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mt-6">
                <!-- Chart Tugas Selesai -->
                <div class="bg-white p-6 rounded-lg shadow-sm border">
                    <h3 class="text-lg font-semibold text-gray-800">Tugas Selesai Mingguan</h3>
                    <!-- Placeholder Chart (Bar) -->
                    <div class="mt-4 h-60 flex items-end justify-between gap-2">
                        <div class="w-1/7 bg-cyan-500 rounded-t-md" style="height: 60%"></div>
                        <div class="w-1/7 bg-cyan-500 rounded-t-md" style="height: 75%"></div>
                        <div class="w-1/7 bg-cyan-500 rounded-t-md" style="height: 90%"></div>
                        <div class="w-1/7 bg-cyan-500 rounded-t-md" style="height: 70%"></div>
                        <div class="w-1/7 bg-cyan-500 rounded-t-md" style="height: 50%"></div>
                        <div class="w-1/7 bg-cyan-500 rounded-t-md" style="height: 65%"></div>
                        <div class="w-1/7 bg-cyan-500 rounded-t-md" style="height: 40%"></div>
                    </div>
                </div>
                <!-- Chart Sesi Pomodoro -->
                <div class="bg-white p-6 rounded-lg shadow-sm border">
                    <h3 class="text-lg font-semibold text-gray-800">Sesi Pomodoro Mingguan</h3>
                    <!-- Placeholder Chart (Line) -->
                    <div class="mt-4 h-60 flex items-center justify-center">
                        <svg class="w-full h-full" viewBox="0 0 300 150" preserveAspectRatio="none">
                            <path d="M 0 80 L 50 60 L 100 90 L 150 70 L 200 100 L 250 80 L 300 70" fill="none" stroke="#06b6d4" stroke-width="2" />
                        </svg>
                    </div>
                </div>
            </div>

            <!-- Target Mingguan -->
            <div class="bg-white p-6 rounded-lg shadow-sm border mt-6">
                 <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-semibold text-gray-800">Target Mingguan</h3>
                    <span class="text-sm font-semibold text-cyan-600">85% tercapai</span>
                 </div>
                 <div class="space-y-4">
                    <!-- Target Item -->
                    <div>
                        <div class="flex justify-between text-sm mb-1">
                            <span class="font-medium text-gray-700">Target Tugas</span>
                            <span class="text-gray-500"><span id="target-tasks-current">0</span>/<span id="target-tasks-goal">20</span></span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-2">
                            <div id="target-tasks-progress" class="bg-cyan-600 h-2 rounded-full" style="width: 0%"></div>
                        </div>
                    </div>
                     <!-- Target Item -->
                    <div>
                        <div class="flex justify-between text-sm mb-1">
                            <span class="font-medium text-gray-700">Target Pomodoro</span>
                            <span class="text-gray-500"><span id="target-pomodoros-current">0</span>/<span id="target-pomodoros-goal">50</span></span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-2">
                            <div id="target-pomodoros-progress" class="bg-cyan-600 h-2 rounded-full" style="width: 0%"></div>
                        </div>
                    </div>
                     <!-- Target Item -->
                    <div>
                        <div class="flex justify-between text-sm mb-1">
                            <span class="font-medium text-gray-700">Waktu Fokus</span>
                            <span class="text-gray-500"><span id="target-focus-current">0</span> jam</span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-2">
                            <div id="target-focus-progress" class="bg-cyan-600 h-2 rounded-full" style="width: 0%"></div>
                        </div>
                    </div>
                 </div>
            </div>

            <!-- Pencapaian -->
            <div class="mt-6">
                <h3 class="text-lg font-semibold text-gray-800 mb-4">Pencapaian</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                    <!-- Achievement Card -->
                    <div class="bg-white p-4 rounded-lg shadow-sm border flex items-center gap-4 opacity-50">
                        <div class="p-2.5 bg-gray-100 rounded-full">
                            <svg class="icon-md text-gray-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M16.5 18.75h-9m9 0a3 3 0 0 1 3 3h-15a3 3 0 0 1 3-3m9 0v-3.375c0-.621-.504-1.125-1.125-1.125h-6.75c-.621 0-1.125.504-1.125 1.125V18.75m9 0h-9" /></svg>
                        </div>
                        <div>
                            <p class="text-sm font-semibold text-gray-700">Pemula Produktif</p>
                            <p class="text-xs text-gray-500">Selesaikan 10 tugas</p>
                        </div>
                    </div>
                    <!-- Achievement Card (Contoh Tercapai) -->
                     <div class="bg-white p-4 rounded-lg shadow-sm border flex items-center gap-4">
                        <div class="p-2.5 bg-yellow-100 rounded-full">
                            <svg class="icon-md text-yellow-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M16.5 18.75h-9m9 0a3 3 0 0 1 3 3h-15a3 3 0 0 1 3-3m9 0v-3.375c0-.621-.504-1.125-1.125-1.125h-6.75c-.621 0-1.125.504-1.125 1.125V18.75m9 0h-9" /></svg>
                        </div>
                        <div>
                            <p class="text-sm font-semibold text-gray-700">Konsisten 7 Hari</p>
                            <p class="text-xs text-gray-500">Aktif 7 hari berturut-turut</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </template>

    <!-- Template Halaman Pomodoro -->
    <template id="template-pomodoro">
        <div class="max-w-2xl mx-auto">
            <h1 class="text-3xl font-bold text-gray-900">Pomodoro Timer</h1>
            <p class="text-gray-600 mt-1">Tingkatkan fokus dengan teknik Pomodoro - 25 menit kerja, 5 menit istirahat</p>

            <div class="bg-white rounded-lg p-8 shadow-sm border mt-8 flex flex-col items-center">
                <!-- Pilihan Mode -->
                <div class="bg-gray-100 rounded-lg p-1 flex justify-between items-center w-full max-w-sm">
                    <button data-mode="fokus" class="page-pomodoro-mode-btn w-1/3 py-2.5 rounded-md text-sm font-semibold bg-cyan-600 text-white">Fokus</button>
                    <button data-mode="istirahat" class="page-pomodoro-mode-btn w-1/3 py-2.5 rounded-md text-sm font-semibold text-gray-600">Istirahat</button>
                    <button data-mode="panjang" class="page-pomodoro-mode-btn w-1/3 py-2.5 rounded-md text-sm font-semibold text-gray-600">Istirahat Panjang</button>
                </div>

                <!-- Timer -->
                <div class="flex flex-col items-center justify-center my-10">
                    <h1 id="page-timer-display" class="text-8xl font-bold text-gray-800">25:00</h1>
                    <div class="mt-4 text-sm text-gray-500">
                        <span id="page-pomodoro-count">0</span> sesi selesai
                    </div>
                    <!-- Progress Bar Sesi -->
                    <div class="w-64 bg-gray-200 rounded-full h-1.5 mt-6">
                        <div id="page-timer-progress" class="bg-cyan-600 h-1.5 rounded-full" style="width: 0%"></div>
                    </div>
                </div>

                <!-- Kontrol -->
                <div class="flex items-center justify-center gap-4">
                    <button id="page-start-pause-btn" class="bg-cyan-600 text-white py-3 px-12 rounded-lg font-semibold text-lg hover:bg-cyan-700 transition flex items-center gap-2">
                        <svg class="icon-sm" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M5.25 5.653c0-.856.917-1.398 1.667-.986l11.54 6.347a1.125 1.125 0 0 1 0 1.972l-11.54 6.347a1.125 1.125 0 0 1-1.667-.986V5.653Z" />
                        </svg>
                        <span>Mulai</span>
                    </button>
                    <button id="page-reset-btn" class="w-12 h-12 flex items-center justify-center bg-gray-100 rounded-lg text-gray-600 hover:bg-gray-200">
                        <svg class="icon-sm" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M16.023 9.348h4.992v-.001M2.985 19.644v-4.992m0 0h4.992m-4.993 0 3.181 3.183a8.25 8.25 0 0 0 13.803-3.7M4.031 9.865a8.25 8.25 0 0 1 13.803-3.7l3.181 3.182m0-4.991v4.99" />
                        </svg>
                    </button>
                    <button id="page-skip-btn" class="w-12 h-12 flex items-center justify-center bg-gray-100 rounded-lg text-gray-600 hover:bg-gray-200">
                        <svg class="icon-sm" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" d="m5.25 4.5 7.5 7.5-7.5 7.5m6-15 7.5 7.5-7.5 7.5" />
                        </svg>
                    </button>
                </div>
            </div>
             <!-- Tugas Saat Ini -->
            <div class="mt-8">
                <h4 class="text-sm font-semibold text-gray-800">Tugas saat ini:</h4>
                <p id="page-current-focus-task" class="text-sm text-gray-500 mt-1">Pilih tugas untuk difokuskan</p>
            </div>
        </div>
    </template>
    
    <!-- Template Halaman Pengaturan -->
    <template id="template-settings">
         <div class="max-w-4xl mx-auto">
            <h1 class="text-3xl font-bold text-gray-900">Pengaturan</h1>
            <p class="text-gray-600 mt-1">Sesuaikan preferensi dan pengaturan aplikasi Anda</p>

            <!-- Pengaturan Timer -->
            <div class="bg-white rounded-lg shadow-sm border mt-8">
                <div class="p-6 border-b">
                    <h3 class="text-lg font-semibold text-gray-800">Timer Pomodoro</h3>
                </div>
                <div class="p-6 space-y-5">
                    <div class="flex justify-between items-center">
                        <div>
                            <p class="font-medium text-gray-700">Durasi Fokus</p>
                            <p class="text-sm text-gray-500">Waktu untuk sesi fokus</p>
                        </div>
                        <input type="number" id="setting-duration-fokus" value="25" class="w-20 rounded-md border-gray-300 text-sm text-right">
                    </div>
                    <div class="flex justify-between items-center">
                        <div>
                            <p class="font-medium text-gray-700">Durasi Istirahat Pendek</p>
                            <p class="text-sm text-gray-500">Waktu untuk istirahat singkat</p>
                        </div>
                        <input type="number" id="setting-duration-istirahat" value="5" class="w-20 rounded-md border-gray-300 text-sm text-right">
                    </div>
                    <div class="flex justify-between items-center">
                        <div>
                            <p class="font-medium text-gray-700">Durasi Istirahat Panjang</p>
                            <p class="text-sm text-gray-500">Setelah 4 sesi fokus</p>
                        </div>
                        <input type="number" id="setting-duration-panjang" value="15" class="w-20 rounded-md border-gray-300 text-sm text-right">
                    </div>
                </div>
            </div>

            <!-- Pengaturan Notifikasi -->
            <div class="bg-white rounded-lg shadow-sm border mt-6">
                <div class="p-6 border-b">
                    <h3 class="text-lg font-semibold text-gray-800">Notifikasi</h3>
                </div>
                <div class="p-6 space-y-5">
                    <div class="flex justify-between items-center">
                        <div>
                            <p class="font-medium text-gray-700">Notifikasi Desktop</p>
                            <p class="text-sm text-gray-500">Tampilkan notifikasi di desktop</p>
                        </div>
                        <input type="checkbox" id="setting-notif-desktop" class="rounded h-5 w-5 text-cyan-600 focus:ring-cyan-500">
                    </div>
                    <div class="flex justify-between items-center">
                        <div>
                            <p class="font-medium text-gray-700">Suara</p>
                            <p class="text-sm text-gray-500">Mainkan suara saat timer selesai</p>
                        </div>
                        <input type="checkbox" id="setting-notif-suara" class="rounded h-5 w-5 text-cyan-600 focus:ring-cyan-500">
                    </div>
                    <div class="flex justify-between items-center">
                        <div>
                            <p class="font-medium text-gray-700">Pengingat Tugas</p>
                            <p class="text-sm text-gray-500">Ingatkan tugas yang akan jatuh tempo</p>
                        </div>
                        <input type="checkbox" id="setting-peringat-tugas" class="rounded h-5 w-5 text-cyan-600 focus:ring-cyan-500">
                    </div>
                </div>
            </div>

             <!-- Pengaturan Tampilan -->
            <div class="bg-white rounded-lg shadow-sm border mt-6">
                <div class="p-6 border-b">
                    <h3 class="text-lg font-semibold text-gray-800">Tampilan</h3>
                </div>
                <div class="p-6 space-y-5">
                    <div class="flex justify-between items-center">
                        <div>
                            <p class="font-medium text-gray-700">Mode Terang</p>
                            <p class="text-sm text-gray-500">Gunakan tema gelap</p>
                        </div>
                        <select id="setting-mode-terang" class="rounded-md border-gray-300 text-sm">
                            <option value="otomatis">Otomatis</option>
                            <option value="terang">Terang</option>
                            <option value="gelap">Gelap</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>
    </template>

    <!-- TEMPLATE BARU UNTUK PROMPT LOGIN -->
    <template id="template-login-prompt">
        <div class="max-w-xl mx-auto text-center bg-white p-10 rounded-lg shadow-sm border mt-10">
            <svg class="icon-lg text-cyan-500 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" d="M16.5 10.5V6.75a4.5 4.5 0 1 0-9 0v3.75m-.75 11.25h10.5a2.25 2.25 0 0 0 2.25-2.25v-6.75a2.25 2.25 0 0 0-2.25-2.25H6.75a2.25 2.25 0 0 0-2.25 2.25v6.75a2.25 2.25 0 0 0 2.25 2.25Z" />
            </svg>
            <h2 class="text-2xl font-bold text-gray-800 mt-4">Login Diperlukan</h2>
            <p class="text-gray-600 mt-2">Anda harus login untuk mengakses Task Manager, Progress, dan Pengaturan. Fitur Pomodoro Timer tersedia gratis.</p>
            <button id="prompt-login-btn" class="mt-6 bg-cyan-600 text-white py-2.5 px-6 rounded-lg font-semibold hover:bg-cyan-700 transition">
                Login Sekarang
            </button>
        </div>
    </template>


    <!-- Firebase SDK -->
    <script type="module">
        // Impor fungsi-fungsi yang diperlukan dari Firebase SDK
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, setPersistence, inMemoryPersistence } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, addDoc, setDoc, updateDoc, onSnapshot, collection, query, where, getDocs, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- KONFIGURASI FIREBASE (WAJIB) ---
        // Variabel-variabel ini akan disediakan oleh lingkungan Canvas
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let db, auth, userId, isLoggedIn = false;
        let tasks = [], projects = [];
        let currentView = 'tasks';
        let currentFocusTask = { id: null, title: 'Pilih tugas untuk difokuskan' };

        // Variabel Status Pomodoro
        let userSettings = {
            durationFokus: 25,
            durationIstirahat: 5,
            durationPanjang: 15,
            notifDesktop: true,
            notifSuara: true,
            peringatTugas: true,
            modeTerang: 'otomatis'
        };
        let timerMode = 'fokus'; // fokus, istirahat, panjang
        let timerDuration = { fokus: 25 * 60, istirahat: 5 * 60, panjang: 15 * 60 };
        let timeLeft = timerDuration.fokus;
        let timerInterval = null;
        let isTimerRunning = false;
        let pomodoroSessionCount = 0;

        // Elemen DOM
        const contentArea = document.getElementById('content-area');
        const projectListEl = document.getElementById('project-list');
        const userInfoEl = document.getElementById('user-info');
        const pomodoroSidebar = document.getElementById('pomodoro-sidebar');
        
        // Elemen DOM Pomodoro
        const timerDisplay = document.getElementById('timer-display');
        const timerProgress = document.getElementById('timer-progress');
        const startPauseBtn = document.getElementById('start-pause-btn');
        const skipBtn = document.getElementById('skip-btn');
        const resetBtn = document.getElementById('reset-btn');
        const modeButtons = document.querySelectorAll('.pomodoro-mode-btn');
        const currentFocusTaskEl = document.getElementById('current-focus-task');
        const pomodoroCountEl = document.getElementById('pomodoro-count');

        // --- INISIALISASI APLIKASI ---
        async function initialize() {
            try {
                // Inisialisasi Firebase
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                // Aktifkan log debug untuk Firestore
                // setLogLevel('debug');

                // Atur persistensi auth (opsional, tapi bagus untuk iframe)
                await setPersistence(auth, inMemoryPersistence);

                // Autentikasi pengguna
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        isLoggedIn = true;
                        console.log("Autentikasi berhasil, User ID:", userId);
                        userInfoEl.textContent = `User ID: ${userId}`;
                        
                        // Muat pengaturan pengguna DULU
                        await loadUserSettings();
                        
                        // Terapkan pengaturan ke timer
                        timerDuration = {
                            fokus: (userSettings.durationFokus || 25) * 60,
                            istirahat: (userSettings.durationIstirahat || 5) * 60,
                            panjang: (userSettings.durationPanjang || 15) * 60,
                        };
                        if (!isTimerRunning) {
                             timeLeft = timerDuration[timerMode];
                             updateTimerDisplay(); // Update timer di sidebar
                        }
                        
                        // Setelah auth siap, muat data
                        await setupFirestoreListeners();
                        await seedDefaultData(); // Buat data default jika perlu
                        navigateTo(currentView); // Render tampilan awal (atau render ulang setelah login)
                    } else {
                        // Pengguna tidak login
                        userId = null;
                        isLoggedIn = false;
                        console.log("Pengguna tidak login (Tamu).");
                        userInfoEl.textContent = "Status: Tamu (Silakan Login)";
                        
                        // Render project list untuk tamu
                        renderProjectList(); 
                        
                        // Terapkan pengaturan default ke timer (untuk pomodoro publik)
                        userSettings = {
                            durationFokus: 25,
                            durationIstirahat: 5,
                            durationPanjang: 15,
                        };
                        timerDuration = {
                            fokus: userSettings.durationFokus * 60,
                            istirahat: userSettings.durationIstirahat * 60,
                            panjang: userSettings.durationPanjang * 60,
                        };
                        timeLeft = timerDuration.fokus;
                        updateTimerDisplay();

                        navigateTo(currentView); // Render tampilan awal (mungkin akan diblokir)
                    }
                });

            } catch (error) {
                console.error("Error saat inisialisasi:", error);
                contentArea.innerHTML = `<p class="text-red-500">Error: Gagal terhubung ke database. Cek konsol untuk detail.</p>`;
            }
        }

        async function authenticateUser() {
            try {
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (error) {
                console.error("Error saat autentikasi:", error);
            }
        }

        // --- LOGIKA FIRESTORE ---

        // Fungsi baru untuk memuat pengaturan
        async function loadUserSettings() {
            if (!isLoggedIn || !userId) return; // Guard clause
            const settingsDocPath = `artifacts/${appId}/users/${userId}/settings/main`;
            try {
                const docSnap = await getDoc(doc(db, settingsDocPath));
                if (docSnap.exists()) {
                    userSettings = { ...userSettings, ...docSnap.data() };
                    console.log("Pengaturan pengguna dimuat:", userSettings);
                } else {
                    // Belum ada pengaturan, simpan default
                    await setDoc(doc(db, settingsDocPath), userSettings);
                    console.log("Pengaturan default disimpan.");
                }
            } catch (error) {
                console.error("Error memuat pengaturan:", error);
            }
        }

        // Fungsi baru untuk menyimpan satu pengaturan
        async function saveUserSetting(key, value) {
            if (!isLoggedIn || !userId) return; // Guard clause
            userSettings[key] = value; // Update salinan lokal
            
            const settingsDocPath = `artifacts/${appId}/users/${userId}/settings/main`;
            try {
                await setDoc(doc(db, settingsDocPath), { [key]: value }, { merge: true });
                console.log(`Pengaturan disimpan: ${key} = ${value}`);
                
                // Jika pengaturan durasi berubah, perbarui logika timer
                if (key.startsWith('duration')) {
                     timerDuration = {
                        fokus: (userSettings.durationFokus || 25) * 60,
                        istirahat: (userSettings.durationIstirahat || 5) * 60,
                        panjang: (userSettings.durationPanjang || 15) * 60,
                    };
                    // Jika timer tidak berjalan, reset waktu ke durasi baru
                    if (!isTimerRunning && (
                        (key === 'durationFokus' && timerMode === 'fokus') ||
                        (key === 'durationIstirahat' && timerMode === 'istirahat') ||
                        (key === 'durationPanjang' && timerMode === 'panjang')
                    )) {
                        timeLeft = timerDuration[timerMode];
                        updateTimerDisplay(); // Update semua timer display
                    }
                }
            } catch (error) {
                console.error("Error menyimpan pengaturan:", error);
            }
        }


        // Membuat listener realtime untuk data
        async function setupFirestoreListeners() {
            if (!isLoggedIn || !userId) return;

            const tasksPath = `artifacts/${appId}/users/${userId}/tasks`;
            const projectsPath = `artifacts/${appId}/users/${userId}/projects`;

            // Listener untuk Tasks
            const tasksQuery = query(collection(db, tasksPath), where("completed", "==", false));
            onSnapshot(tasksQuery, (snapshot) => {
                tasks = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                console.log("Tasks dimuat:", tasks);
                if (currentView === 'tasks') {
                    renderTaskManager();
                }
            }, (error) => console.error("Error listener tasks:", error));

            // Listener untuk Projects
            const projectsQuery = query(collection(db, projectsPath));
            onSnapshot(projectsQuery, (snapshot) => {
                projects = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                console.log("Projects dimuat:", projects);
                renderProjectList();
                // Juga re-render tugas jika kita di halaman tugas, karena tag mungkin perlu update
                if (currentView === 'tasks') {
                    renderTaskManager();
                }
            }, (error) => console.error("Error listener projects:", error));
            
            // Listener/Getter untuk Stats (hanya ambil sekali saat memuat halaman progress)
            // Listener realtime untuk stats bisa jadi mahal jika sering diupdate
        }

        // Data default untuk pengguna baru
        async function seedDefaultData() {
            if (!isLoggedIn || !userId) return; // Guard clause

            if (projects.length === 0) {
                console.log("Membuat proyek default...");
                const projectsPath = `artifacts/${appId}/users/${userId}/projects`;
                await addDoc(collection(db, projectsPath), { name: 'Kuliah', color: 'blue-500' });
                await addDoc(collection(db, projectsPath), { name: 'Pribadi', color: 'green-500' });
                await addDoc(collection(db, projectsPath), { name: 'Pekerjaan', color: 'purple-500' });
            }
        }

        // --- FUNGSI RENDER ---

        // Render daftar proyek di sidebar
        function renderProjectList() {
            projectListEl.innerHTML = '';
            if (!isLoggedIn) {
                projectListEl.innerHTML = '<li class="p-3 text-sm text-gray-400">Login untuk melihat proyek.</li>';
                return;
            }
            if (projects.length === 0) {
                projectListEl.innerHTML = '<li class="p-3 text-sm text-gray-400">Belum ada proyek.</li>';
                return;
            }
            projects.forEach(project => {
                const li = document.createElement('li');
                li.innerHTML = `
                    <a href="#" class="flex items-center gap-3 px-3 py-2.5 rounded-lg text-gray-600 hover:bg-gray-100">
                        <span class="w-3 h-3 rounded-full bg-${project.color || 'gray-500'}"></span>
                        ${project.name}
                    </a>
                `;
                projectListEl.appendChild(li);
            });
        }
        
        // Render Tampilan Task Manager
        function renderTaskManager() {
            const template = document.getElementById('template-tasks');
            contentArea.innerHTML = '';
            contentArea.appendChild(template.content.cloneNode(true));
            pomodoroSidebar.classList.remove('hidden'); // Tampilkan sidebar pomodoro

            const activeTasksList = document.getElementById('active-tasks-list');
            activeTasksList.innerHTML = '';

            if (tasks.length === 0) {
                activeTasksList.innerHTML = '<div class="p-4 text-center text-gray-500">Tidak ada tugas aktif.</div>';
            } else {
                tasks.forEach(task => {
                    const taskItem = createTaskElement(task);
                    activeTasksList.appendChild(taskItem);
                });
            }

            // Tambahkan event listener untuk form
            document.getElementById('add-task-form').addEventListener('submit', handleAddTask);
        }

        // Buat elemen HTML untuk satu tugas
        function createTaskElement(task) {
            const template = document.getElementById('template-task-item');
            const el = template.content.cloneNode(true);

            el.querySelector('.task-title').textContent = task.title;
            el.querySelector('.task-due-date').innerHTML = `
                <svg class="icon-sm" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M6.75 3v2.25M17.25 3v2.25M3 18.75V7.5a2.25 2.25 0 0 1 2.25-2.25h13.5A2.25 2.25 0 0 1 21 7.5v11.25m-18 0A2.25 2.25 0 0 0 5.25 21h13.5A2.25 2.25 0 0 0 21 18.75m-18 0v-7.5A2.25 2.25 0 0 1 5.25 9h13.5A2.25 2.25 0 0 1 21 11.25v7.5" /></svg>
                ${task.dueDate || 'Hari ini'}`;
            el.querySelector('.task-pomodoros').innerHTML = `
                <svg class="icon-sm" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 6v6h4.5m4.5 0a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" /></svg>
                ${task.pomodoroCount || 0} pomodoro`;

            const tagsContainer = el.querySelector('.task-tags');
            if (task.tags && Array.isArray(task.tags)) {
                task.tags.forEach(tagName => {
                    const project = projects.find(p => p.name === tagName);
                    const color = project ? project.color : 'gray-400';
                    const tagEl = document.createElement('span');
                    tagEl.className = `text-xs font-semibold px-2.5 py-0.5 rounded-full bg-${color.split('-')[0]}-100 text-${color.split('-')[0]}-700`;
                    tagEl.textContent = tagName;
                    tagsContainer.appendChild(tagEl);
                });
            }

            // Event listener untuk tombol Selesai
            el.querySelector('.task-complete-btn').addEventListener('click', () => handleCompleteTask(task.id));
            
            // Event listener untuk tombol Fokus
            el.querySelector('.task-focus-btn').addEventListener('click', () => {
                currentFocusTask = { id: task.id, title: task.title };
                currentFocusTaskEl.textContent = task.title;
                currentFocusTaskEl.classList.remove('text-gray-500');
                console.log("Fokus pada tugas:", task.title);
            });

            return el;
        }
        
        // Render Tampilan Progress
        async function renderProgressTracking() {
            const template = document.getElementById('template-progress');
            contentArea.innerHTML = '';
            contentArea.appendChild(template.content.cloneNode(true));
            pomodoroSidebar.classList.add('hidden'); // Sembunyikan sidebar pomodoro

            // Ambil data stats dari Firestore
            if (!isLoggedIn || !userId) return; // Guard clause
            const statsDocPath = `artifacts/${appId}/users/${userId}/stats/main`;
            
            try {
                const docSnap = await getDoc(doc(db, statsDocPath));
                let stats = { tasksCompleted: 0, pomodorosCompleted: 0, consecutiveDays: 0, dailyTargetRatio: "0/20", dailyTargetPercent: 0, targetTasksCurrent: 0, targetTasksGoal: 20, targetPomodorosCurrent: 0, targetPomodorosGoal: 50, targetFocusCurrent: 0, targetFocusGoal: 18.5 };

                if (docSnap.exists()) {
                    const data = docSnap.data();
                    stats = { ...stats, ...data }; // Gabungkan default dengan data dari DB
                } else {
                    console.log("Dokumen stats belum ada, akan dibuat.");
                    await setDoc(doc(db, statsDocPath), stats);
                }

                // Update DOM dengan data stats
                document.getElementById('stat-tasks-completed').textContent = stats.tasksCompleted;
                document.getElementById('stat-pomodoros-completed').textContent = stats.pomodorosCompleted;
                document.getElementById('stat-consecutive-days').textContent = stats.consecutiveDays;
                document.getElementById('stat-daily-target').textContent = `${stats.dailyTargetPercent}%`;
                document.getElementById('stat-daily-target-ratio').textContent = stats.dailyTargetRatio;

                document.getElementById('target-tasks-current').textContent = stats.targetTasksCurrent;
                document.getElementById('target-tasks-goal').textContent = stats.targetTasksGoal;
                document.getElementById('target-tasks-progress').style.width = `${(stats.targetTasksCurrent / stats.targetTasksGoal) * 100}%`;

                document.getElementById('target-pomodoros-current').textContent = stats.targetPomodorosCurrent;
                document.getElementById('target-pomodoros-goal').textContent = stats.targetPomodorosGoal;
                document.getElementById('target-pomodoros-progress').style.width = `${(stats.targetPomodorosCurrent / stats.targetPomodorosGoal) * 100}%`;

                document.getElementById('target-focus-current').textContent = `${stats.targetFocusCurrent} jam`;
                document.getElementById('target-focus-progress').style.width = `${(stats.targetFocusCurrent / stats.targetFocusGoal) * 100}%`;

            } catch (error) {
                console.error("Error mengambil stats:", error);
            }
        }

        // *** FUNGSI RENDER BARU ***

        // Render Halaman Pomodoro
        function renderPomodoroPage() {
            const template = document.getElementById('template-pomodoro');
            contentArea.innerHTML = '';
            contentArea.appendChild(template.content.cloneNode(true));
            pomodoroSidebar.classList.add('hidden'); // Sembunyikan sidebar

            // Perbarui tampilan halaman dengan status timer saat ini
            document.getElementById('page-timer-display').textContent = formatTime(timeLeft);
            document.getElementById('page-pomodoro-count').textContent = pomodoroSessionCount;
            document.getElementById('page-current-focus-task').textContent = currentFocusTask.title;
            
            if (isTimerRunning) {
                const btnSpan = document.getElementById('page-start-pause-btn').querySelector('span');
                if (btnSpan) btnSpan.textContent = 'Jeda';
            }
            
            // Sinkronkan tombol mode
            switchMode(timerMode); 
            updateTimerDisplay(); // Sinkronkan progress bar

            // Hubungkan event listener untuk Halaman Pomodoro
            document.getElementById('page-start-pause-btn').addEventListener('click', () => {
                if (isTimerRunning) pauseTimer();
                else startTimer();
            });
            document.getElementById('page-reset-btn').addEventListener('click', resetTimer);
            document.getElementById('page-skip-btn').addEventListener('click', () => {
                if(timerMode === 'fokus') switchMode('istirahat');
                else switchMode('fokus');
            });
            document.querySelectorAll('.page-pomodoro-mode-btn').forEach(btn => {
                btn.addEventListener('click', (e) => switchMode(e.currentTarget.dataset.mode));
            });
        }

        // Render Halaman Pengaturan
        function renderSettings() {
            const template = document.getElementById('template-settings');
            contentArea.innerHTML = '';
            contentArea.appendChild(template.content.cloneNode(true));
            pomodoroSidebar.classList.add('hidden'); // Sembunyikan sidebar

            // Isi kolom input dengan pengaturan yang dimuat
            document.getElementById('setting-duration-fokus').value = userSettings.durationFokus;
            document.getElementById('setting-duration-istirahat').value = userSettings.durationIstirahat;
            document.getElementById('setting-duration-panjang').value = userSettings.durationPanjang;
            
            document.getElementById('setting-notif-desktop').checked = userSettings.notifDesktop;
            document.getElementById('setting-notif-suara').checked = userSettings.notifSuara;
            document.getElementById('setting-peringat-tugas').checked = userSettings.peringatTugas;
            
            document.getElementById('setting-mode-terang').value = userSettings.modeTerang;

            // Tambahkan event listener untuk menyimpan saat diubah
            document.getElementById('setting-duration-fokus').addEventListener('change', (e) => saveUserSetting('durationFokus', parseInt(e.target.value)));
            document.getElementById('setting-duration-istirahat').addEventListener('change', (e) => saveUserSetting('durationIstirahat', parseInt(e.target.value)));
            document.getElementById('setting-duration-panjang').addEventListener('change', (e) => saveUserSetting('durationPanjang', parseInt(e.target.value)));
            
            document.getElementById('setting-notif-desktop').addEventListener('change', (e) => saveUserSetting('notifDesktop', e.target.checked));
            document.getElementById('setting-notif-suara').addEventListener('change', (e) => saveUserSetting('notifSuara', e.target.checked));
            document.getElementById('setting-peringat-tugas').addEventListener('change', (e) => saveUserSetting('peringatTugas', e.target.checked));

            document.getElementById('setting-mode-terang').addEventListener('change', (e) => saveUserSetting('modeTerang', e.target.value));
        }

        // Render Halaman Prompt Login (FUNGSI BARU)
        function renderLoginPrompt() {
            const template = document.getElementById('template-login-prompt');
            contentArea.innerHTML = '';
            contentArea.appendChild(template.content.cloneNode(true));
            pomodoroSidebar.classList.add('hidden'); // Sembunyikan sidebar

            // Hubungkan tombol login
            document.getElementById('prompt-login-btn').addEventListener('click', () => {
                authenticateUser();
                // onAuthStateChanged akan menangani rendering ulang secara otomatis
            });
        }


        // --- HANDLER AKSI ---

        // Navigasi
        function navigateTo(view) {
            currentView = view;
            
            // Update style tombol navigasi
            document.querySelectorAll('.nav-item').forEach(el => {
                el.classList.remove('nav-active');
                if (el.dataset.view === view) {
                    el.classList.add('nav-active');
                }
            });

            // Daftar view yang memerlukan login
            const privateViews = ['tasks', 'progress', 'settings'];

            if (privateViews.includes(view) && !isLoggedIn) {
                // Jika mencoba akses halaman privat & belum login, tampilkan prompt
                renderLoginPrompt();
            } else {
                // Jika login ATAU mengakses halaman publik (pomodoro)
                contentArea.innerHTML = ''; // Hapus konten lama
                
                if (view === 'tasks') {
                    renderTaskManager();
                } else if (view === 'progress') {
                    renderProgressTracking();
                } else if (view === 'pomodoro') {
                    renderPomodoroPage();
                } else if (view === 'settings') {
                    renderSettings();
                }
            }
        }

        // Tambah Tugas
        async function handleAddTask(event) {
            event.preventDefault();
            if (!isLoggedIn || !userId) return; // Guard clause

            const titleInput = document.getElementById('new-task-title');
            const title = titleInput.value.trim();

            if (title) {
                try {
                    const tasksPath = `artifacts/${appId}/users/${userId}/tasks`;
                    // Coba cari tag proyek dari judul (sederhana)
                    let tags = [];
                    projects.forEach(p => {
                        if (title.toLowerCase().includes(p.name.toLowerCase())) {
                            tags.push(p.name);
                        }
                    });

                    await addDoc(collection(db, tasksPath), {
                        title: title,
                        completed: false,
                        createdAt: new Date(),
                        dueDate: "Hari ini",
                        pomodoroCount: 0,
                        tags: tags.length > 0 ? tags : ['Pribadi'] // default tag
                    });
                    titleInput.value = ''; // Kosongkan input
                } catch (error) {
                    console.error("Error menambah tugas:", error);
                }
            }
        }

        // Selesaikan Tugas
        async function handleCompleteTask(taskId) {
            if (!isLoggedIn || !userId) return; // Guard clause
            console.log("Menyelesaikan tugas:", taskId);
            const taskDocPath = `artifacts/${appId}/users/${userId}/tasks/${taskId}`;
            try {
                await updateDoc(doc(db, taskDocPath), {
                    completed: true
                });
                
                // Hapus tugas dari DOM (akan dihapus oleh listener, tapi ini memberi feedback instan)
                // renderTaskManager(); 
                // Sebenarnya tidak perlu, onSnapshot akan menangani
                
                // Update stats (contoh sederhana)
                await updateStatsOnTaskComplete();

            } catch (error) {
                console.error("Error menyelesaikan tugas:", error);
            }
        }

        // Fungsi untuk update stats (sangat disederhanakan)
        async function updateStatsOnTaskComplete() {
            if (!isLoggedIn || !userId) return; // Guard clause
            const statsDocPath = `artifacts/${appId}/users/${userId}/stats/main`;
            try {
                const docSnap = await getDoc(doc(db, statsDocPath));
                if (docSnap.exists()) {
                    const stats = docSnap.data();
                    const newTasksCompleted = (stats.tasksCompleted || 0) + 1;
                    const newTargetTasksCurrent = (stats.targetTasksCurrent || 0) + 1;
                    
                    // Hitung target harian
                    const dailyTargetGoal = 20; // Hardcode
                    const dailyTargetRatio = `${newTasksCompleted % dailyTargetGoal}/${dailyTargetGoal}`;
                    const dailyTargetPercent = Math.floor(((newTasksCompleted % dailyTargetGoal) / dailyTargetGoal) * 100);

                    await updateDoc(doc(db, statsDocPath), {
                        tasksCompleted: newTasksCompleted,
                        targetTasksCurrent: newTargetTasksCurrent,
                        dailyTargetRatio: dailyTargetRatio,
                        dailyTargetPercent: dailyTargetPercent
                    });
                }
            } catch (error) {
                console.error("Error update stats:", error);
            }
        }


        // --- LOGIKA POMODORO ---

        // Fungsi helper baru untuk format waktu
        function formatTime(timeInSeconds) {
            const minutes = Math.floor(timeInSeconds / 60);
            const seconds = timeInSeconds % 60;
            return `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
        }

        function updateTimerDisplay() {
            const formattedTime = formatTime(timeLeft);
            const totalDuration = timerDuration[timerMode];
            const progressPercent = ((totalDuration - timeLeft) / totalDuration) * 100;

            // Update Sidebar (jika ada)
            if (timerDisplay) timerDisplay.textContent = formattedTime;
            if (timerProgress) timerProgress.style.width = `${progressPercent}%`;

            // Update Halaman Pomodoro (jika ada)
            const pageTimerDisplay = document.getElementById('page-timer-display');
            const pageTimerProgress = document.getElementById('page-timer-progress');
            if (pageTimerDisplay) pageTimerDisplay.textContent = formattedTime;
            if (pageTimerProgress) pageTimerProgress.style.width = `${progressPercent}%`;
        }

        function startTimer() {
            isTimerRunning = true;
            // Update tombol sidebar
            if (startPauseBtn) startPauseBtn.textContent = 'Jeda';
            // Update tombol halaman
            const pageBtn = document.getElementById('page-start-pause-btn');
            if (pageBtn) {
                const btnSpan = pageBtn.querySelector('span');
                if (btnSpan) btnSpan.textContent = 'Jeda';
                // Ganti ikon ke "pause" jika ada (opsional)
            }
            
            timerInterval = setInterval(() => {
                timeLeft--;
                updateTimerDisplay();

                if (timeLeft < 0) {
                    clearInterval(timerInterval);
                    isTimerRunning = false;
                    handleTimerEnd();
                }
            }, 1000);
        }

        function pauseTimer() {
            isTimerRunning = false;
            // Update tombol sidebar
            if (startPauseBtn) startPauseBtn.textContent = 'Mulai';
            // Update tombol halaman
            const pageBtn = document.getElementById('page-start-pause-btn');
            if (pageBtn) {
                const btnSpan = pageBtn.querySelector('span');
                if (btnSpan) btnSpan.textContent = 'Mulai';
                 // Ganti ikon ke "play" jika ada (opsional)
            }
            clearInterval(timerInterval);
        }

        function handleTimerEnd() {
            if (timerMode === 'fokus') {
                pomodoroSessionCount++;
                if(pomodoroCountEl) pomodoroCountEl.textContent = `${pomodoroSessionCount} sesi selesai`;
                const pagePomodoroCount = document.getElementById('page-pomodoro-count');
                if(pagePomodoroCount) pagePomodoroCount.textContent = pomodoroSessionCount;
                
                // Auto-switch ke istirahat
                switchMode('istirahat');
                // TODO: Update pomodoro count untuk 'currentFocusTask' di Firestore
                if (currentFocusTask.id) {
                    updateTaskPomodoroCount(currentFocusTask.id);
                }
            } else {
                // Auto-switch kembali ke fokus
                switchMode('fokus');
            }
            // Mainkan suara notifikasi (sulit di iframe, jadi kita skip)
        }
        
        async function updateTaskPomodoroCount(taskId) {
            if (!isLoggedIn || !userId) return; // Guard clause
            const taskDocPath = `artifacts/${appId}/users/${userId}/tasks/${taskId}`;
            try {
                const taskDoc = await getDoc(doc(db, taskDocPath));
                if(taskDoc.exists()) {
                    const newCount = (taskDoc.data().pomodoroCount || 0) + 1;
                    await updateDoc(doc(db, taskDocPath), {
                        pomodoroCount: newCount
                    });
                }
            } catch (error) {
                console.error("Error update pomodoro count:", error);
            }
        }

        function resetTimer() {
            pauseTimer();
            timeLeft = timerDuration[timerMode];
            updateTimerDisplay();

            // HAPUS LOGIKA YANG SALAH DARI SINI
            /*
            // Update style tombol mode sidebar
            modeButtons.forEach(btn => {
                if (btn.dataset.mode === newMode) {
                    btn.classList.add('bg-white', 'text-cyan-700', 'shadow-sm');
                    btn.classList.remove('text-gray-600');
                } else {
                    btn.classList.remove('bg-white', 'text-cyan-700', 'shadow-sm');
                    btn.classList.add('text-gray-600');
                }
            });
            
            // Update warna progress bar sidebar
            const newColor = (newMode === 'fokus') ? 'bg-cyan-600' : 'bg-green-500';
            if(timerProgress) timerProgress.className = `h-1.5 rounded-full ${newColor}`;

            // Update style tombol mode Halaman
            const pageModeButtons = document.querySelectorAll('.page-pomodoro-mode-btn');
            pageModeButtons.forEach(btn => {
                if (btn.dataset.mode === newMode) {
                    btn.classList.add('bg-cyan-600', 'text-white');
                    btn.classList.remove('text-gray-600', 'bg-gray-100');
                } else {
                    btn.classList.remove('bg-cyan-600', 'text-white');
                    btn.classList.add('text-gray-600', 'bg-gray-100');
                }
            });
            
            // Update warna progress bar Halaman
            const pageTimerProgress = document.getElementById('page-timer-progress');
            if (pageTimerProgress) pageTimerProgress.className = `h-1.5 rounded-full ${newColor}`;
            */
        }

        // FUNGSI switchMode YANG SEBELUMNYA HILANG (PASTIKAN INI ADA)
        function switchMode(newMode) {
            timerMode = newMode;
            pauseTimer();
            timeLeft = timerDuration[newMode];
            updateTimerDisplay();

            // Update style tombol mode sidebar
            modeButtons.forEach(btn => {
                if (btn.dataset.mode === newMode) {
                    btn.classList.add('bg-white', 'text-cyan-700', 'shadow-sm');
                    btn.classList.remove('text-gray-600');
                } else {
                    btn.classList.remove('bg-white', 'text-cyan-700', 'shadow-sm');
                    btn.classList.add('text-gray-600');
                }
            });
            
            // Update warna progress bar sidebar
            const newColor = (newMode === 'fokus') ? 'bg-cyan-600' : 'bg-green-500';
            if(timerProgress) timerProgress.className = `h-1.5 rounded-full ${newColor}`;

            // Update style tombol mode Halaman
            const pageModeButtons = document.querySelectorAll('.page-pomodoro-mode-btn');
            pageModeButtons.forEach(btn => {
                if (btn.dataset.mode === newMode) {
                    btn.classList.add('bg-cyan-600', 'text-white');
                    btn.classList.remove('text-gray-600', 'bg-gray-100');
                } else {
                    btn.classList.remove('bg-cyan-600', 'text-white');
                    btn.classList.add('text-gray-600', 'bg-gray-100');
                }
            });
            
            // Update warna progress bar Halaman
            const pageTimerProgress = document.getElementById('page-timer-progress');
            if (pageTimerProgress) pageTimerProgress.className = `h-1.5 rounded-full ${newColor}`;
        }

        // --- Event Listeners Global ---
        document.addEventListener('DOMContentLoaded', () => {
            initialize();

            // Listener navigasi sidebar
            document.querySelectorAll('.nav-item').forEach(el => {
                el.addEventListener('click', (e) => {
                    e.preventDefault();
                    const view = e.currentTarget.dataset.view;
                    if (view) {
                        navigateTo(view);
                    }
                });
            });

            // Listener Pomodoro
            startPauseBtn.addEventListener('click', () => {
                if (isTimerRunning) {
                    pauseTimer();
                } else {
                    startTimer();
                }
            });
            
            resetBtn.addEventListener('click', resetTimer);
            skipBtn.addEventListener('click', () => {
                if(timerMode === 'fokus') switchMode('istirahat');
                else switchMode('fokus');
            });

            modeButtons.forEach(btn => {
                btn.addEventListener('click', (e) => {
                    switchMode(e.currentTarget.dataset.mode);
                });
            });

        });

    </script>
</body>
</html>